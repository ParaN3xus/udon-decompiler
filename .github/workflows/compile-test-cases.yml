name: Compile Test Cases

on:
  workflow_dispatch:
  push:
    paths:
      - "tests/cases/**/*.md"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: unityci/editor:ubuntu-2022.3.22f1-base-3.2.1

    env:
      PROJECT_NAME: temp_proj
      INPUT_JSON: input.json
      OUTPUT_JSON: output.json
      BUILD_LOG: build.log
      CASES_DIR: tests/cases

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup VRChat Project
        uses: ./.github/actions/setup-vrchat-project
        with:
          project_name: ${{ env.PROJECT_NAME }}

      - name: Generate input.json from Cases
        shell: bash
        run: |
          set -euo pipefail
          python3 -m tests.ci.case_md build-input \
            --cases "${{ env.CASES_DIR }}" \
            --output "$PROJECT_NAME/$INPUT_JSON"

          echo "Generated input.json at $PROJECT_NAME/$INPUT_JSON"

      - name: Run Unity Compilation
        working-directory: ${{ env.PROJECT_NAME }}
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        run: |
          ABS_PATH=$(pwd)

          set +e
          /opt/unity/Editor/Unity \
            -username "$UNITY_EMAIL" \
            -password "$UNITY_PASSWORD" \
            -serial "$UNITY_SERIAL" \
            -batchmode \
            -nographics \
            -projectPath . \
            -executeMethod UdonCompilerCLI.Run \
            -inputFile "$ABS_PATH/$INPUT_JSON" \
            -outputFile "$ABS_PATH/$OUTPUT_JSON" \
            -logFile "$ABS_PATH/$BUILD_LOG"

          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            echo "Unity exited with code $EXIT_CODE"
          fi

      - name: Sanitize Build Log
        if: always()
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        uses: ./.github/actions/sanitize-unity-log
        with:
          build_log_path: ${{ env.PROJECT_NAME }}/${{ env.BUILD_LOG }}

      - name: Update cases markdown with dumped.json
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          ERR_MSG=$(jq -r '.error' "$PROJECT_NAME/$OUTPUT_JSON")
          if [ "$ERR_MSG" != "null" ] && [ -n "$ERR_MSG" ]; then
              echo "Error found in output.json: $ERR_MSG"
              exit 1
          fi

          python3 -m tests.ci.case_md update-md \
            --input "$PROJECT_NAME/$INPUT_JSON" \
            --output "$PROJECT_NAME/$OUTPUT_JSON"

      - name: Commit and push updated cases (Success)
        if: success()
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -n "${GITHUB_WORKSPACE:-}" ]; then
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add tests/cases

          if git diff --cached --quiet; then
            echo "No case updates to commit."
            exit 0
          fi

          git commit -m "test: compile test cases"
          git push

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: ${{ env.PROJECT_NAME }}/${{ env.BUILD_LOG }}
          if-no-files-found: ignore
