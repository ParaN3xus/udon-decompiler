name: Compile Test Cases

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: unityci/editor:ubuntu-2022.3.22f1-base-3.2.1

    env:
      PROJECT_NAME: temp_proj
      INPUT_JSON: input.json
      OUTPUT_JSON: output.json
      BUILD_LOG: build.log

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: apt-get update && apt-get install -y jq

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install VRChat Package Manager (VPM)
        run: |
          dotnet tool install --global vrchat.vpm.cli
          echo "/github/home/.dotnet/tools" >> $GITHUB_PATH

      - name: Create VRChat Project
        run: |
          vpm install templates
          vpm new "$PROJECT_NAME" World -p .

      - name: Update VRChat World SDK Packages
        working-directory: ${{ env.PROJECT_NAME }}
        run: |
          function vpm_update_latest() {
            local pkg_name=$1
            local latest_ver=$(vpm check package "$pkg_name" | grep "version:" | awk '{print $NF}')
            if [ -n "$latest_ver" ]; then
                echo "Installing $pkg_name@$latest_ver"
                vpm add package "${pkg_name}@${latest_ver}"
            else
                echo "ERR: Failed to check latest version of $pkg_name"
                exit 1
            fi
          }

          vpm_update_latest "com.vrchat.base"
          vpm_update_latest "com.vrchat.worlds"

      - name: Copy Editor Scripts
        run: |
          mkdir -p "$PROJECT_NAME/Assets/Editor"
          cp -r Editor/* "$PROJECT_NAME/Assets/Editor/"

      - name: Generate input.json from Tests
        run: |
          ls tests/*.cs | while read -r file; do
              filename=$(basename -- "$file")
              classname="${filename%.*}"
              
              jq -n \
                 --arg name "$classname" \
                 --rawfile code "$file" \
                 '{className: $name, sourceCode: $code}'
          done | jq -s '{requests: .}' > "$PROJECT_NAME/$INPUT_JSON"

          echo "Generated input.json at $PROJECT_NAME/$INPUT_JSON"

      - name: Run Unity Compilation
        working-directory: ${{ env.PROJECT_NAME }}
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        run: |
          ABS_PATH=$(pwd)

          set +e
          /opt/unity/Editor/Unity \
            -username "$UNITY_EMAIL" \
            -password "$UNITY_PASSWORD" \
            -serial "$UNITY_SERIAL" \
            -batchmode \
            -nographics \
            -projectPath . \
            -executeMethod UdonCompilerCLI.Run \
            -inputFile "$ABS_PATH/$INPUT_JSON" \
            -outputFile "$ABS_PATH/$OUTPUT_JSON" \
            -logFile "$ABS_PATH/$BUILD_LOG"

          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            echo ">>> Unity exited with code $EXIT_CODE"
          fi

      - name: Sanitize Build Log
        if: always()
        working-directory: ${{ env.PROJECT_NAME }}
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        run: |
          if [ -f "$BUILD_LOG" ]; then
            MASK="********************************"
            
            sed -i "s|$UNITY_EMAIL|$MASK|g" "$BUILD_LOG"
            sed -i "s|$UNITY_PASSWORD|$MASK|g" "$BUILD_LOG"
            sed -i "s|$UNITY_SERIAL|$MASK|g" "$BUILD_LOG"
            
            echo ">>> Log sanitized."
          else
            echo ">>> No build log found to sanitize."
          fi

      - name: Extract Dumped Programs
        working-directory: ${{ env.PROJECT_NAME }}
        run: |
          ERR_MSG=$(jq -r '.error' "$OUTPUT_JSON")
          if [ "$ERR_MSG" != "null" ] && [ -n "$ERR_MSG" ]; then
              echo ">>> Error found in output.json: $ERR_MSG"
              exit 1
          fi

          count=$(jq '.results | length' "$OUTPUT_JSON")
          echo "Found $count results."

          mkdir -p output_dumps
          for (( i=0; i<$count; i++ )); do
              classname=$(jq -r ".requests[$i].className" "$INPUT_JSON")
              jq -r ".results[$i]" "$OUTPUT_JSON" > "output_dumps/${classname}.dumped.json"
              echo "Extracted: ${classname}.dumped.json"
          done

      - name: Upload Dumped JSON (Success)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: dumped-programs
          path: ${{ env.PROJECT_NAME }}/output_dumps/*.dumped.json

      - name: Upload Build Log (Failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: ${{ env.PROJECT_NAME }}/${{ env.BUILD_LOG }}
