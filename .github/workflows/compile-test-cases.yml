name: Compile Test Cases

on:
  workflow_dispatch:
  push:
    paths:
      - "tests/cases/**/*.md"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: unityci/editor:ubuntu-2022.3.22f1-base-3.2.1

    env:
      PROJECT_NAME: temp_proj
      INPUT_JSON: input.json
      OUTPUT_JSON: output.json
      BUILD_LOG: build.log
      CASES_DIR: tests/cases

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install VRChat Package Manager (VPM)
        run: |
          dotnet tool install --global vrchat.vpm.cli
          echo "/github/home/.dotnet/tools" >> $GITHUB_PATH

      - name: Create VRChat Project
        run: |
          vpm install templates
          vpm new "$PROJECT_NAME" World -p .

      - name: Update VRChat World SDK Packages
        working-directory: ${{ env.PROJECT_NAME }}
        shell: bash
        run: |
          vpm_update_latest() {
            local pkg_name=$1
            local latest_ver=$(vpm check package "$pkg_name" | grep "version:" | awk '{print $NF}')
            if [ -n "$latest_ver" ]; then
                echo "Installing $pkg_name@$latest_ver"
                vpm add package "${pkg_name}@${latest_ver}"
            else
                echo "ERR: Failed to check latest version of $pkg_name"
                exit 1
            fi
          }

          vpm_update_latest "com.vrchat.base"
          vpm_update_latest "com.vrchat.worlds"

      - name: Copy Editor Scripts
        run: |
          mkdir -p "$PROJECT_NAME/Assets/Editor"
          cp -r Editor/* "$PROJECT_NAME/Assets/Editor/"

      - name: Generate input.json from Cases
        shell: bash
        run: |
          set -euo pipefail
          python3 -m tests.ci.case_md build-input \
            --cases "${{ env.CASES_DIR }}" \
            --output "$PROJECT_NAME/$INPUT_JSON"

          echo "Generated input.json at $PROJECT_NAME/$INPUT_JSON"

      - name: Run Unity Compilation
        working-directory: ${{ env.PROJECT_NAME }}
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        run: |
          ABS_PATH=$(pwd)

          set +e
          /opt/unity/Editor/Unity \
            -username "$UNITY_EMAIL" \
            -password "$UNITY_PASSWORD" \
            -serial "$UNITY_SERIAL" \
            -batchmode \
            -nographics \
            -projectPath . \
            -executeMethod UdonCompilerCLI.Run \
            -inputFile "$ABS_PATH/$INPUT_JSON" \
            -outputFile "$ABS_PATH/$OUTPUT_JSON" \
            -logFile "$ABS_PATH/$BUILD_LOG"

          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            echo "Unity exited with code $EXIT_CODE"
          fi

      - name: Sanitize Build Log
        if: always()
        working-directory: ${{ env.PROJECT_NAME }}
        shell: bash
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        run: |
          if [ -f "$BUILD_LOG" ]; then
            MASK="********************************"
            
            sed -i "s|$UNITY_EMAIL|$MASK|g" "$BUILD_LOG"
            sed -i "s|$UNITY_PASSWORD|$MASK|g" "$BUILD_LOG"
            sed -i "s|$UNITY_SERIAL|$MASK|g" "$BUILD_LOG"

            LEN=${#UNITY_SERIAL}
            PREFIX=${UNITY_SERIAL:0:LEN-4}
            UNITY_AUTO_MASKED="${PREFIX}XXXX"
            sed -i "s|$UNITY_AUTO_MASKED|$MASK|g" "$BUILD_LOG"
            
            echo "Log sanitized."
          else
            echo "No build log found to sanitize."
          fi

      - name: Update cases markdown with dumped.json
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          ERR_MSG=$(jq -r '.error' "$PROJECT_NAME/$OUTPUT_JSON")
          if [ "$ERR_MSG" != "null" ] && [ -n "$ERR_MSG" ]; then
              echo "Error found in output.json: $ERR_MSG"
              exit 1
          fi

          python3 -m tests.ci.case_md update-md \
            --input "$PROJECT_NAME/$INPUT_JSON" \
            --output "$PROJECT_NAME/$OUTPUT_JSON"

      - name: Commit and push updated cases (Success)
        if: success()
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -n "${GITHUB_WORKSPACE:-}" ]; then
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add tests/cases

          if git diff --cached --quiet; then
            echo "No case updates to commit."
            exit 0
          fi

          git commit -m "test: compile test cases"
          git push

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: ${{ env.PROJECT_NAME }}/${{ env.BUILD_LOG }}
          if-no-files-found: ignore
