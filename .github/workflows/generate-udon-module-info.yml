name: Generate UdonModuleInfo.json

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    container:
      image: unityci/editor:ubuntu-2022.3.22f1-base-3.2.1

    env:
      PROJECT_NAME: temp_proj
      BUILD_LOG: build.log

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup VRChat Project
        uses: ./.github/actions/setup-vrchat-project
        with:
          project_name: ${{ env.PROJECT_NAME }}

      - name: Run Unity Extraction
        working-directory: ${{ env.PROJECT_NAME }}
        shell: bash
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        run: |
          set +e
          /opt/unity/Editor/Unity \
            -username "$UNITY_EMAIL" \
            -password "$UNITY_PASSWORD" \
            -serial "$UNITY_SERIAL" \
            -batchmode \
            -nographics \
            -projectPath . \
            -executeMethod UdonModuleInfoExtractor.ExtractModuleInfo \
            -logFile "$(pwd)/build.log"

          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            echo "Unity exited with code $EXIT_CODE"
            exit $EXIT_CODE
          fi

      - name: Collect UdonModuleInfo.json
        shell: bash
        run: |
          set -euo pipefail
          SRC_PATH="${{ env.PROJECT_NAME }}/Assets/UdonModuleInfo.json"
          if [ ! -f "$SRC_PATH" ]; then
            echo "UdonModuleInfo.json not found at $SRC_PATH"
            exit 1
          fi
          cp "$SRC_PATH" "${{ github.workspace }}/UdonModuleInfo.json"

      - name: Upload UdonModuleInfo.json to release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_TAG: ${{ vars.UDON_MODULE_INFO_RELEASE_TAG }}
        run: |
          set -euo pipefail
          if [ -z "${RELEASE_TAG}" ]; then
            echo "UDON_MODULE_INFO_RELEASE_TAG is not set."
            exit 1
          fi
          if [ ! -f "${{ github.workspace }}/UdonModuleInfo.json" ]; then
            echo "Asset not found: ${{ github.workspace }}/UdonModuleInfo.json"
            exit 1
          fi
          gh release upload "${RELEASE_TAG}" "${{ github.workspace }}/UdonModuleInfo.json" --clobber

      - name: Sanitize Build Log
        if: always()
        env:
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
        uses: ./.github/actions/sanitize-unity-log
        with:
          build_log_path: ${{ env.PROJECT_NAME }}/${{ env.BUILD_LOG }}

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: ${{ env.PROJECT_NAME }}/${{ env.BUILD_LOG }}
          if-no-files-found: ignore
